<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ | elbowH的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="记录学习过程">
    
    <link rel="preload" href="/mynotes/assets/css/0.styles.1c00a5d2.css" as="style"><link rel="preload" href="/mynotes/assets/js/app.ff3e2c4c.js" as="script"><link rel="preload" href="/mynotes/assets/js/2.ecabc25e.js" as="script"><link rel="preload" href="/mynotes/assets/js/13.b15b8047.js" as="script"><link rel="prefetch" href="/mynotes/assets/js/10.f937fc65.js"><link rel="prefetch" href="/mynotes/assets/js/11.488bd455.js"><link rel="prefetch" href="/mynotes/assets/js/12.8cb0935e.js"><link rel="prefetch" href="/mynotes/assets/js/14.b4be6fd0.js"><link rel="prefetch" href="/mynotes/assets/js/3.132b138a.js"><link rel="prefetch" href="/mynotes/assets/js/4.20835d87.js"><link rel="prefetch" href="/mynotes/assets/js/5.954ec756.js"><link rel="prefetch" href="/mynotes/assets/js/6.dafc0921.js"><link rel="prefetch" href="/mynotes/assets/js/7.3fa0e32c.js"><link rel="prefetch" href="/mynotes/assets/js/8.85ac5431.js"><link rel="prefetch" href="/mynotes/assets/js/9.0dccee13.js">
    <link rel="stylesheet" href="/mynotes/assets/css/0.styles.1c00a5d2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mynotes/" class="home-link router-link-active"><!----> <span class="site-name">elbowH的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mynotes/" class="nav-link">
  主页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mynotes/" class="nav-link">
  主页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/mynotes/mybatis/MyBatis总结.html" class="sidebar-link">Mybatis</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>微服务</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>分布式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>RabbitMQ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mynotes/microservices/rabbitmq/RabbitMQ介绍和安装.html" class="active sidebar-link">RabbitMQ介绍和安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mynotes/microservices/rabbitmq/RabbitMQ介绍和安装.html#_1-同步通讯和异步通讯" class="sidebar-link">1. 同步通讯和异步通讯</a></li><li class="sidebar-sub-header"><a href="/mynotes/microservices/rabbitmq/RabbitMQ介绍和安装.html#_2-消息中间件" class="sidebar-link">2. 消息中间件</a></li><li class="sidebar-sub-header"><a href="/mynotes/microservices/rabbitmq/RabbitMQ介绍和安装.html#_3-rabbitmq" class="sidebar-link">3. RabbitMQ</a></li></ul></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rabbitmq"><a href="#rabbitmq" class="header-anchor">#</a> RabbitMQ</h1> <h2 id="_1-同步通讯和异步通讯"><a href="#_1-同步通讯和异步通讯" class="header-anchor">#</a> 1. 同步通讯和异步通讯</h2> <p>微服务间通讯有同步和异步两种方式：</p> <p>同步通讯：就像打电话，需要实时响应。</p> <p>异步通讯：就像发邮件，不需要马上回复。</p> <p><img src="/%E5%9B%BE1.1.png" alt=""></p> <p>两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发送邮件可以同时与多个人收发邮件，但是往往响应会有延迟。</p> <h3 id="_1-1-同步通讯"><a href="#_1-1-同步通讯" class="header-anchor">#</a> 1.1 同步通讯</h3> <p>我们之前学习的Feign调用就属于同步方式，虽然调用可以实时得到结果，但存在下面的问题：</p> <p><img src="/%E5%9B%BE1.2.png" alt=""></p> <p><strong>总结：</strong></p> <p><strong>同步调用的优点：</strong></p> <ul><li>时效性较强，可以立即得到结果</li></ul> <p><strong>同步调用的问题：</strong></p> <ul><li>耦合度高</li> <li>性能和吞吐能力下降</li> <li>有额外的资源消耗</li> <li>有级联失败问题</li></ul> <p><img src="/%E5%9B%BE1.3.png" alt=""></p> <h3 id="_1-2-异步通讯"><a href="#_1-2-异步通讯" class="header-anchor">#</a> 1.2 异步通讯</h3> <ul><li><strong>异步调用则可以避免上述问题：</strong></li></ul> <blockquote><p>我们以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，调用物流服务，从仓库分配响应的库存并准备发货。</p> <p>在事件模式中，支付服务是事件发布者（publisher），在支付完成后只需要发布一个支付成功的事件（event），事件中带上订单id。</p> <p>订单服务和物流服务是事件订阅者（Consumer），订阅支付成功的事件，监听到事件后完成自己业务即可。</p> <p>为了解除事件发布者与订阅者之间的耦合，两者并不是直接通信，而是有一个中间人（Broker）。发布者发布事件到Broker，不关心谁来订阅事件。订阅者从Broker订阅事件，不关心谁发来的消息。</p> <p><img src="/%E5%9B%BE1.4.png" alt=""></p></blockquote> <ul><li><strong>异步调用常见实现就是事件驱动模式</strong></li></ul> <p><img src="/%E5%9B%BE1.5.png" alt=""></p> <p><strong>Broker 是一个像数据总线一样的东西，所有的服务要接收数据和发送数据都发到这个总线上，这个总线就像协议一样，让服务间的通讯变得标准和可控。</strong></p> <p><strong>好处：</strong></p> <ul><li>吞吐量提升：无需等待订阅者处理完成，响应更快速</li> <li>故障隔离：服务没有直接调用，不存在级联失败问题
<ul><li><img src="/%E5%9B%BE1.8.png" alt=""></li></ul></li> <li>调用间没有阻塞，不会造成无效的资源占用
<ul><li><img src="/%E5%9B%BE1.7.png" alt=""></li></ul></li> <li>耦合度极低，每个服务都可以灵活插拔，可替换
<ul><li><img src="/%E5%9B%BE1.6.png" alt=""></li></ul></li> <li>流量削峰：不管发布事件的流量波动多大，都由Broker接收，订阅者可以按照自己的速度去处理事件
<ul><li><img src="/%E5%9B%BE1.9.png" alt=""></li></ul></li></ul> <p><strong>缺点：</strong></p> <ul><li>架构复杂了，业务没有明显的流程线，不好管理</li> <li>需要依赖于Broker的可靠、安全、性能</li></ul> <p>好在现在开源软件或云平台上 Broker 的软件是非常成熟的，比较常见的一种就是我们今天要学习的MQ技术。</p> <h2 id="_2-消息中间件"><a href="#_2-消息中间件" class="header-anchor">#</a> 2. 消息中间件</h2> <h3 id="_2-1-什么是消息中间件"><a href="#_2-1-什么是消息中间件" class="header-anchor">#</a> 2.1 什么是消息中间件</h3> <p>​        MQ全称为Message Queue，消息队列是应用程序和应用程序之间的通信方法，字面来看就是存放消息的队列。也就是事件驱动架构中的Broker。</p> <ul><li><strong>为什么使用MQ ?</strong></li></ul> <p>​        在项目中，可将一些无需即时返回且耗时的操作提取出来，进行异步处理，而这种异步处理的方式
大大的节省了服务器的请求响应时间，从而提高了系统的吞吐量。</p> <ul><li><strong>开发中消息队列通常有如下应用场景：</strong></li></ul> <ol><li><strong>任务异步处理</strong></li></ol> <p>​         将不需要同步处理的并且耗时长的操作由消息队列通知消息接收方进行异步处理。提高了应用程序
的响应时间。</p> <ol start="2"><li><strong>应用程序解耦合</strong></li></ol> <p>MQ相当于一个中介，生产方通过MQ与消费方交互，它将应用程序进行解耦合。</p> <ol start="3"><li><strong>削峰填谷</strong></li></ol> <p>​         如订单系统，在下单的时候就会往数据库写数据。但是数据库只能支撑每秒1000左右的并发写入，
并发量再高就容易宕机。低峰期的时候并发也就100多个，但是在高峰期时候，并发量会突然激增
到5000以上，这个时候数据库肯定卡死了。</p> <p><img src="/%E5%9B%BE2.1.png" alt=""></p> <p>消息被MQ保存起来了，然后系统就可以按照自己的消费能力来消费，比如每秒1000个数据，这样
慢慢写入数据库，这样就不会卡死数据库了。</p> <p><img src="/%E5%9B%BE2.2.png" alt=""></p> <p>但是使用了MQ之后，限制消费消息的速度为1000，但是这样一来，高峰期产生的数据势必会被积
压在MQ中，高峰就被“削”掉了。但是因为消息积压，在高峰期过后的一段时间内，消费消息的速
度还是会维持在1000QPS，直到消费完积压的消息,这就叫做“填谷”</p> <p><img src="/%E5%9B%BE2.3.png" alt=""></p> <h3 id="_2-2-amqp-和-jms"><a href="#_2-2-amqp-和-jms" class="header-anchor">#</a> 2.2 AMQP 和 JMS</h3> <p>MQ是消息通信的模型；实现MQ的大致有两种主流方式：AMQP、JMS。</p> <ul><li><p><strong>AMQP</strong></p> <ul><li>AMQP是一种协议，更准确的说是一种binary wire-level protocol（链接协议）。这是其和JMS的本质差别，AMQP不从API层进行限定，而是直接定义网络交换的数据格式。</li></ul></li> <li><p><strong>JMS</strong></p> <ul><li>JMS即Java消息服务（JavaMessage Service）应用程序接口，是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。</li></ul></li> <li><p><strong>AMQP 与 JMS 区别的区别</strong></p> <ul><li>JMS是定义了统一的接口，来对消息操作进行统一；AMQP是通过规定协议来统一数据交互的格式</li> <li>JMS限定了必须使用Java语言；AMQP只是协议，不规定实现方式，因此是跨语言的。</li> <li>JMS规定了两种消息模式；而AMQP的消息模式更加丰富</li></ul></li></ul> <h3 id="_2-3-消息队列产品"><a href="#_2-3-消息队列产品" class="header-anchor">#</a> 2.3 消息队列产品</h3> <p>市场上常见的消息队列有如下：</p> <ul><li>ActiveMQ：基于JMS,誉为消息中间件领域的“瑞士军刀”。</li> <li>ZeroMQ：基于C语言开发。</li> <li>RabbitMQ：基于AMQP协议，erlang语言开发，稳定性好; 吞吐量和性能完美平衡。</li> <li>RocketMQ：基于JMS，阿里巴巴产品，高吞吐量。</li> <li>Kafka：类似MQ的产品；分布式消息系统，高吞吐量。</li></ul> <p><img src="/%E5%9B%BE2.4.png" alt=""></p> <table><thead><tr><th></th> <th><strong>RabbitMQ</strong></th> <th><strong>ActiveMQ</strong></th> <th><strong>RocketMQ</strong></th> <th><strong>Kafka</strong></th></tr></thead> <tbody><tr><td>公司/社区</td> <td>Rabbit</td> <td>Apache</td> <td>阿里</td> <td>Apache</td></tr> <tr><td>开发语言</td> <td>Erlang</td> <td>Java</td> <td>Java</td> <td>Scala&amp;Java</td></tr> <tr><td>协议支持</td> <td>AMQP，XMPP，SMTP，STOMP</td> <td>OpenWire,STOMP，REST,XMPP,AMQP</td> <td>自定义协议</td> <td>自定义协议</td></tr> <tr><td>可用性</td> <td>高</td> <td>一般</td> <td>高</td> <td>高</td></tr> <tr><td>单机吞吐量</td> <td>一般</td> <td>差</td> <td>高</td> <td>非常高</td></tr> <tr><td>消息延迟</td> <td>微秒级</td> <td>毫秒级</td> <td>毫秒级</td> <td>毫秒以内</td></tr> <tr><td>消息可靠性</td> <td>高</td> <td>一般</td> <td>高</td> <td>一般</td></tr></tbody></table> <p>追求可用性：Kafka、 RocketMQ 、RabbitMQ</p> <p>追求可靠性：RabbitMQ、RocketMQ</p> <p>追求吞吐能力：RocketMQ、Kafka</p> <p>追求消息低延迟：RabbitMQ、Kafka</p> <h2 id="_3-rabbitmq"><a href="#_3-rabbitmq" class="header-anchor">#</a> 3. RabbitMQ</h2> <h3 id="_3-1-rabbitmq-简介"><a href="#_3-1-rabbitmq-简介" class="header-anchor">#</a> 3.1 RabbitMQ 简介</h3> <p>​	<code>RabbitMQ</code>是由erlang语言开发，基于<code>AMQP</code>（Advanced Message Queue 高级消息队列协议）协议实现的消息队列，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。RabbitMQ官方地址：http://www.rabbitmq.com/
​	RabbitMQ提供了7种模式：<code>简单模式</code>，<code>work模式</code>，<code>Publish/Subscribe发布与订阅模式</code>，<code>Routing路由模式</code>，<code>Topics主题模式</code>，<code>RPC远程调用模式</code>（远程调用,企业很少使用，不作介绍），Publisher Confirms模式(使用较少，不作介绍)，我们后面主要学习前5中模式。官网对应模式介绍：https://www.rabbitmq.com/getstarted.html</p> <p><img src="/%E5%9B%BE3.1.png" alt=""></p> <h3 id="_3-2-rabbitmq-安装及配置"><a href="#_3-2-rabbitmq-安装及配置" class="header-anchor">#</a> 3.2 RabbitMQ 安装及配置</h3> <h4 id="_3-2-1-windosw版安装"><a href="#_3-2-1-windosw版安装" class="header-anchor">#</a> 3.2.1 Windosw版安装</h4> <p><strong>windows10环境下的RabbitMQ安装步骤</strong></p> <h5 id="_3-2-1-1-先安装erlang"><a href="#_3-2-1-1-先安装erlang" class="header-anchor">#</a> 3.2.1.1 先安装erlang</h5> <ol><li><strong>下载并安装erlang</strong></li></ol> <blockquote><p>第一步：下载并安装erlang
原因：RabbitMQ服务端代码是使用并发式语言Erlang编写的，安装Rabbit MQ的前提是安装Erlang。
下载地址：http://www.erlang.org/downloads</p></blockquote> <p><img src="/%E5%9B%BE3.2.png" alt=""></p> <ol start="2"><li><strong>下载完：otp_win64_23.3.4.15.exe 是这样的一个exe程序，双击，点next就可以。</strong></li></ol> <p><img src="/%E5%9B%BE3.3.png" alt=""></p> <p><strong>选择一个自己想保存的地方，然后next、finish就可以。</strong></p> <p><img src="/%E5%9B%BE3.4.png" alt=""></p> <ol start="3"><li>安装完事儿后要记得配置一下系统的环境变量。
此电脑–&gt;鼠标右键“属性”–&gt;高级系统设置–&gt;环境变量–&gt;“新建”系统环境变量</li></ol> <p><img src="/%E5%9B%BE3.5.png" alt=""></p> <ol start="4"><li>变量名：ERLANG_HOME，变量值就是刚才erlang的安装地址，点击确定。然后双击系统变量path</li></ol> <p><img src="/%E5%9B%BE3.6.png" alt=""></p> <ol start="5"><li>点击“新建”，将%ERLANG_HOME%\bin加入到path中。</li></ol> <p><img src="/%E5%9B%BE3.7.png" alt=""></p> <ol start="6"><li>最后windows键+R键，输入cmd，再输入erl，看到版本号就说明erlang安装成功了。</li></ol> <p><img src="/%E5%9B%BE3.8.png" alt=""></p> <h5 id="_3-2-1-2-安装rabbitmq"><a href="#_3-2-1-2-安装rabbitmq" class="header-anchor">#</a> 3.2.1.2 安装rabbitmq</h5> <ol><li>下载并安装RabbitMQ，下载地址：http://www.rabbitmq.com/download.html</li></ol> <p><img src="/%E5%9B%BE3.9.png" alt=""></p> <ol start="2"><li><p>双击下载后的.exe文件，安装过程与erlang的安装过程相同。RabbitMQ安装好后接下来安装RabbitMQ-Plugins。打开命令行cd，输入RabbitMQ的sbin目录。</p> <p>我的目录是：D:\Program Files\RabbitMQ Server\rabbitmq_server-3.7.3\sbin
然后在后面输入rabbitmq-plugins enable rabbitmq_management命令进行安装</p></li></ol> <p><img src="/%E5%9B%BE3.10.png" alt=""></p> <ol start="3"><li><strong>打开命令行命令行,进入RabbitMQ的安装目录: sbin,输入 rabbitmqctl status , 如果出现以下的图，说明安装是成功的，并且说明现在RabbitMQ Server已经启动了,运行正常。</strong></li></ol> <p><img src="/%E5%9B%BE3.11.png" alt=""></p> <ol start="4"><li><strong>RabbitMQ在windows下的安装打开sbin目录，双击rabbitmq-server.bat</strong></li></ol> <p><img src="/%E5%9B%BE3.12.png" alt=""></p> <p>等几秒钟看到这个界面后，访问http://localhost:15672</p> <ol start="5"><li><strong>也可以在服务管理台进行开启和关闭rabbitmq的服务</strong></li></ol> <p><img src="/%E5%9B%BE3.13.png" alt=""></p> <h4 id="_3-2-2-linux-版安装"><a href="#_3-2-2-linux-版安装" class="header-anchor">#</a> 3.2.2 Linux 版安装</h4> <p>​	 RabbitMQ服务器是采用并发式语言Erlang编写的，安装Rabbit MQ的前提是安装Erlang，并设置环境变量ERLANG_HOME后，RabbitMQ才能正常启动。Erlang与RabbitMQ的对应关系可参考官方网站https://www.rabbitmq.com/which-erlang.html。
​	Erlang的下载地址是:http://erlang.org/download/。 注意centos7不支持erlang24,建议下载otp_src_23.3.tar.gz 或直接在网上下载rpm安装包。RabbitMQ安装文件官网下载速度较慢，可以在华为开源镜像站https://repo.huaweicloud.com/rabbitmq-server/下载。</p> <h5 id="_3-2-2-1-linux系统中直接安装rabbitmq"><a href="#_3-2-2-1-linux系统中直接安装rabbitmq" class="header-anchor">#</a> 3.2.2.1  Linux系统中直接安装RabbitMQ</h5> <ol><li>安装依赖环境，如果是centos7mini版，须在线安装依赖环境：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> build-essential openssl openssl-devel unixODBC unixODBC-devel <span class="token function">make</span>
gcc gcc-c++ kernel-devel m4 ncurses-devel tk tc xz
</code></pre></div><ol start="2"><li>安装Erlang</li></ol> <p>​        上传 erlang-18.3-1.el7.centos.x86_64.rpm 、socat-1.7.3.2-5.el7.lux.x86_64.rpm 、rabbitmqserver-3.6.5-1.noarch.rpm。这里的erlang采用的是rpm安装方式，如果采用tar安装方式，需要手工设置环境变量。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 安装</span>
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> erlang-18.3-1.el7.centos.x86_64.rpm
<span class="token comment"># 安装</span>
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> socat-1.7.3.2-5.el7.lux.x86_64.rpm
<span class="token comment"># 安装</span>
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> rabbitmq-server-3.6.5-1.noarch.rpm
</code></pre></div><ol start="3"><li>启动停止服务</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">service</span> rabbitmq-server start <span class="token comment"># 启动服务</span>
<span class="token function">service</span> rabbitmq-server stop <span class="token comment"># 停止服务</span>
<span class="token function">service</span> rabbitmq-server restart <span class="token comment"># 重启服务</span>
</code></pre></div><ol start="4"><li>开启管理界面及配置</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 开启管理界面</span>
rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_management
<span class="token comment"># 修改默认配置信息,初学者可以不用修改</span>
<span class="token function">vim</span> /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.5/ebin/rabbit.app
<span class="token comment"># 比如修改密码、配置等等，例如：loopback_users 中的 &lt;&lt;&quot;guest&quot;&gt;&gt;,只保留guest</span>

</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /usr/share/doc/rabbitmq-server-3.6.5/
<span class="token function">cp</span> rabbitmq.config.example /etc/rabbitmq/rabbitmq.config <span class="token comment">#如果需要配置，可以添加设置</span>
配置文件
</code></pre></div><p>默认情况下，可以采用默认用户guest(默认密码guest)登录。如果启动服务及开启管理界面后，guest无
法登录，可采用rabbitmqctl命令添加用户及授权。</p> <p><img src="/%E5%9B%BE3.14.png" alt=""></p> <h5 id="_3-2-2-2-采用docker安装rabbitmq"><a href="#_3-2-2-2-采用docker安装rabbitmq" class="header-anchor">#</a> 3.2.2.2  采用docker安装RabbitMQ</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">--name</span> rabbitmq <span class="token parameter variable">-p</span> <span class="token number">5672</span>:5672 <span class="token parameter variable">-p</span> <span class="token number">15672</span>:15672 rabbitmq:3.9-
management
</code></pre></div><h3 id="_3-3-rabbitmq管控台"><a href="#_3-3-rabbitmq管控台" class="header-anchor">#</a> 3.3 RabbitMQ管控台</h3> <p>MQ的基本结构：</p> <p><img src="/%E5%9B%BE4.1.png" alt=""></p> <p><strong>RabbitMQ中的一些角色：</strong></p> <ul><li><strong>publisher：生产者</strong></li> <li><strong>consumer：消费者</strong></li> <li><strong>exchange个：交换机，负责消息路由</strong></li> <li><strong>queue：队列，存储消息</strong></li> <li><strong>virtualHost：虚拟主机，隔离不同租户的exchange、queue、消息的隔离</strong></li></ul> <h4 id="_3-3-1-管控台总览介绍"><a href="#_3-3-1-管控台总览介绍" class="header-anchor">#</a> 3.3.1 管控台总览介绍</h4> <p>管理员可以通过15672端口登录rabbitmq的web管控台。RabbitMQ管控台如下图：</p> <p><img src="/%E5%9B%BE4.2.png" alt=""></p> <p>​	点击<code>RabbitMQ</code>的管控台中概览的Nodes,它表示当前节点的情况状态。其中File descriptors是文件描述，Socket descriptors是通信情况，Erlang processes代表了Erlang的进程数，Memory代表了整个服务的内存使用情况，Disk space代表了磁盘的使用情况，Rates mode，Info代表了存储状态。
​	<code>Paths</code>对应了RabbitMQ的一些配置路径，其中Config file为配置文件路径，Database directory代表了数据的存储路径，Log file代表了日志文件的存储路径。</p> <p><img src="/%E5%9B%BE4.3.png" alt=""></p> <p>​	RabbitMQ的管控台中概览的Ports and contexts，是RabbitMQ提供的端口号都代表了什么含义，<code>amqp</code>默认是<code>5672</code>，clustering集群默认是<code>25672</code>。Web contexts代表了RabbitMQ管控台的端口号是<code>15672</code></p> <p><img src="/%E5%9B%BE4.4.png" alt=""></p> <h4 id="_3-3-2-管控台管理员介绍"><a href="#_3-3-2-管控台管理员介绍" class="header-anchor">#</a> 3.3.2 管控台管理员介绍</h4> <p>​	我们开发应用程序时，一般建议对于每一个应用程序创建一个独立的数据库进行隔离。同样，在rabbimq中，我们采用virtual host(虚拟主机)隔离不同的应用程序。在RabbitMQ中可以配置虚拟主机Virtual Host，每个Virtual Hosts相当于一个相对独立的RabbitMQ服务器，每个VirtualHost之间是相互隔离的。exchange、queue、message不能互通。 相当于Mysql的db。规范的VirtualHost名称一般以/开头。下面我们讲解人配置虚拟主机及用户。
​	点击 Admin → Users，我们可以看到rabbitmq新增用户界面。</p> <p><img src="/%E5%9B%BE4.5.png" alt=""></p> <p>我们可以为用户选择以下不同的角色。</p> <ul><li><strong>超级管理员(administrator)</strong></li></ul> <p>可登陆管理控制台，可查看所有的信息，并且可以对用户，策略(policy)进行操作。</p> <ul><li><strong>监控者(monitoring)</strong></li></ul> <p>可登陆管理控制台，同时可以查看rabbitmq节点的相关信息(进程数，内存使用情况，磁盘使用情况等)</p> <ul><li><strong>策略制定者(policymaker)</strong></li></ul> <p>可登陆管理控制台, 同时可以对policy进行管理。但无法查看节点的相关信息。</p> <ul><li><strong>普通管理者(management)</strong></li></ul> <p>仅可登陆管理控制台，无法看到节点信息，也无法对策略进行管理。</p> <ul><li><strong>其他</strong></li></ul> <p>​        无法登陆管理控制台，通常就是普通的生产者和消费者。点击Admin → Virtual Hosts,我们可以看到虚拟主机管理界面。</p> <p><img src="/%E5%9B%BE4.6.png" alt=""></p> <p>接下来我们可以为虚拟主机选择对应的用户。</p> <p><img src="/%E5%9B%BE4.7.png" alt=""></p> <h4 id="_3-3-3-用户角色"><a href="#_3-3-3-用户角色" class="header-anchor">#</a> 3.3.3 用户角色</h4> <p>​        RabbitMQ安装后，可以直接访问http://localhost:15672/，其自带的用户名：guest，密码：guesst，如果需要自定义创建用户，可以登录页面后操作。</p> <p><img src="/%E5%9B%BE5.5.png" alt=""></p> <p><img src="/%E5%9B%BE5.1.png" alt=""></p> <p><strong>角色说明：</strong></p> <ol><li><p><strong>超级管理员(administrator)</strong></p> <p>可登陆管理控制台，可查看所有的信息，并且可以对用户，策略(policy)进行操作。</p></li> <li><p><strong>监控者(monitoring)</strong></p> <p>可登陆管理控制台，同时可以查看rabbitmq节点的相关信息(进程数，内存使用情况，磁盘使用情况等)</p></li> <li><p><strong>策略制定者(policymaker)</strong></p> <p>可登陆管理控制台,同时可以对policy进行管理。但无法查看节点的相关信息(上图红框标识的部分</p></li> <li><p><strong>普通管理者(management)</strong></p> <p>仅可登陆管理控制台，无法看到节点信息，也无法对策略进行管理。</p></li> <li><p><strong>其他</strong></p> <p>无法登陆管理控制台，通常就是普通的生产者和消费者。</p></li></ol> <h4 id="_3-3-4-virtual-hosts配置"><a href="#_3-3-4-virtual-hosts配置" class="header-anchor">#</a> 3.3.4 Virtual Hosts配置</h4> <ul><li><p><strong>创建一个虚拟主机Virtual Hosts</strong></p> <div class="language- extra-class"><pre><code>  像mysql拥有数据库的概念并且可以指定用户对库和表等操作的权限。RabbitMQ也有类似的权限管理，RabbitMQ中可以虚拟消息服务器Virtual Host，每个Virtual Hosts相当于一个相对独立的RabbitMQ服务器，每个VirtualHost之间是相互隔离的。exchange、queue、message不能互通。相当于mysql的db。Virtual Name一般以/开头。
</code></pre></div></li></ul> <p><img src="/%E5%9B%BE5.2.png" alt=""></p> <ul><li>设置Virtual Hosts权限</li></ul> <p><img src="/%E5%9B%BE5.6.png" alt=""></p> <p><img src="/%E5%9B%BE5.3.png" alt=""></p> <h3 id="_3-4-rabbitmq的使用模式"><a href="#_3-4-rabbitmq的使用模式" class="header-anchor">#</a> 3.4 RabbitMQ的使用模式</h3> <h4 id="_3-4-1-rabbitmq入门"><a href="#_3-4-1-rabbitmq入门" class="header-anchor">#</a> 3.4.1 RabbitMQ入门</h4> <p>接下来，我们开发第一个RabbitMQ程序。我们通过这个程序学习RabbitMQ的模式。
RabbitMQ的入门程序涉及到如下几个对象及角色：</p> <ul><li><code>ConnectionFactory</code>对象: 类似于数据库连接中的DataSource对象, ConnectionFactory在整个应用程序中为全局唯一的，我们可以把它在静态块中初始化。</li> <li><code>Connection</code>对象：一个网络连接，比如TCP/IP套接字连接, 类似于JDBC中的Connection对象。</li> <li><code>Channel</code>对象：信道对象。一个连接对象可以创建多个Channel对象，我们可以声明Channel独占一个连接或者多个信道共享一个连接，信道是RabbitMQ中最核心的一个对象。它的作用有：声明创建队列、声明创建交换机、发布信息、消费信息、确认信息。我们可以把它与MyBatis框架中的SqlSession对象或JDBC中的Statement对象作类比，Statement用来发送SQL语句到数据，Channel可以发送信息到RabbitMQ服务器。</li> <li><code>Queues</code>对象：消息队列对象, Channel发送的信息最终会进入到消息队列中存储，消息队列可以声明为内存存储或永久存储。</li> <li><code>Producer</code>生产者角色: 一个向RabbitMQ的Broker发布消息的客户端应用程序。</li> <li><code>Consumer</code>消费者角色: 一个监听RabbitMQ的消息队列请求消息的应用程序。如果我们利用RabbitMQ解耦合，生产者及消费者往往对应于不同的微服务模块。这里我们为了简单，把它们写在同一个项目中。</li> <li><code>Admin</code>: 可以创建用户，也可以创建虚拟主机Virtual Hosts，创建的用户需要管理虚拟主机。</li></ul> <h4 id="_3-4-2-搭建示例工程"><a href="#_3-4-2-搭建示例工程" class="header-anchor">#</a> 3.4.2 搭建示例工程</h4> <ol><li>创建工程</li></ol> <p><img src="/%E5%9B%BE6.1.png" alt=""></p> <p>项目结构</p> <p><img src="/%E5%9B%BE6.2.png" alt=""></p> <ol start="2"><li>添加依赖</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.rabbitmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>amqp-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.12.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>ch.qos.logback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>logback-classic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.18.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="3"><li>书写RabbitMQ的工具类RabbitUtil.</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ConnectionFactory</span> factory<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">&quot;/tpp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//链接RabbitMQ的端口号</span>
            factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;axjy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//链接密码：默认是guest</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            conn <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建链接</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> conn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">closeAll</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> conn<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> conn<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>可以手动创建队列</li></ol> <p><img src="/%E5%9B%BE6.3.png" alt=""></p> <ol start="5"><li>编写生产者测试程序。也可以通过代码创建队列</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Sender</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">RabbitUtil</span><span class="token punctuation">.</span><span class="token function">getConn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//相当于jdbc的statement，发送信息</span>
        <span class="token class-name">Map</span> arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-max-length-bytes&quot;</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDelete</span><span class="token punctuation">(</span><span class="token string">&quot;my_simple_queue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/** 声明（如果不存在，会创建）
         * 参数1：队列名称     参数2：是否定义持久化队列      参数3：是否独占本次链接 
         * 参数4：是否在不适用的时候自动删除队列      参数5：队列其他参数
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;my_simple_queue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/** 信息发送到队列里  发信息
         * 第一个参数：交换机名称，可以写成“”，空字符为内部默认交换机(没有交换机)
         * 第二个参数：队列的名称    第三个参数：信息的基本属性    第四个参数：信息内容
         */</span>       channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;my_simple_queue&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token string">&quot;fasHi,rabbitaaafasfdasf&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;发送成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RabbitUtil</span><span class="token punctuation">.</span><span class="token function">closeAll</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="6"><li>编写消费者C1测试程序</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetMessage</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">RabbitUtil</span><span class="token punctuation">.</span><span class="token function">getConn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token string">&quot;my_simple_queue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;监听的信息内容：&quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;路由key为：&quot;</span><span class="token operator">+</span>envelope<span class="token punctuation">.</span><span class="token function">getRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//路由key</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;交换机为：&quot;</span><span class="token operator">+</span>envelope<span class="token punctuation">.</span><span class="token function">getExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交换机</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息id为：&quot;</span><span class="token operator">+</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//消息id</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到的消息：&quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//收到的消息</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="7"><li>增加logback记录日志</li></ol> <p>注意，消费者作为监听程序要一直处于运行状态，Connection对象不允许关闭。
上述的入门案例中中其实使用的是如下的简单模式：</p> <p><img src="/%E5%9B%BE6.4.png" alt=""></p> <p>在上图的模型中，有以下概念：
P：生产者，也就是要发送消息的程序
C：消费者：消息的接受者，会一直等待消息到来。
queue：消息队列，图中红色部分。类似一个邮箱，可以缓存消息；生产者向其中投递消息，消费者从其中取出消息。以上就是RabbitMQ的第一种使用模式：简单收发模式（官网又称HelloWorld模式)。它有如下两个特点：
特点：</p> <ol><li><p><strong>无需自定义exchange(实际上采用的是名称为空字符串的默认交换机);</strong></p></li> <li><p><strong>一个生产者，一个消费者。消费者能接受到队列中的所有信息。</strong></p></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mynotes/microservices/distributed/分布式事务.html" class="prev">
        分布式事务
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mynotes/assets/js/app.ff3e2c4c.js" defer></script><script src="/mynotes/assets/js/2.ecabc25e.js" defer></script><script src="/mynotes/assets/js/13.b15b8047.js" defer></script>
  </body>
</html>
